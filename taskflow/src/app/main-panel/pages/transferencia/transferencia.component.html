<div class="w-full">
  <div class="grid justify-content-center">
    <div class="col-12 lg:col-7">
      <p-card class="shadow-4 border-round-2xl overflow-hidden">
        <ng-template pTemplate="header">
          <div
            class="p-5 flex flex-column gap-2"
            style="background: linear-gradient(135deg, #1e293b, #334155); color: white"
          >
            <div class="flex align-items-center gap-3">
              <i class="pi pi-arrow-right-arrow-left text-4xl text-primary"></i>
              <h1 class="m-0 text-3xl font-bold">Transferência entre Contas</h1>
            </div>
            <p class="m-0 opacity-70 font-medium">
              Mova saldo entre suas contas cadastradas.
            </p>
          </div>
        </ng-template>

        <div class="p-4">
          @if (transferenciaRealizada) {
            <!-- Sucesso -->
            <div class="flex flex-column align-items-center gap-4 py-6">
              <i class="pi pi-check-circle text-6xl text-green-500"></i>
              <h2 class="m-0 text-green-700">Transferência realizada!</h2>
              <p class="m-0 text-500 text-center">
                O lançamento foi registrado no extrato de transações.
              </p>
              <p-button
                label="Fazer nova transferência"
                icon="pi pi-plus"
                (click)="novaTransferencia()"
              ></p-button>
            </div>
          } @else {
            <!-- Formulário -->
            <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-column gap-4">

              <!-- Conta de Origem -->
              <div class="flex flex-column gap-1">
                <label class="font-medium">Conta de Origem <span class="text-red-500">*</span></label>
                <p-select
                  formControlName="contaOrigemId"
                  [options]="todasContas"
                  optionLabel="nome"
                  optionValue="id"
                  placeholder="Selecione a conta de origem"
                  styleClass="w-full"
                  [ngClass]="{ 'ng-invalid ng-dirty': campoInvalido('contaOrigemId') }"
                >
                  <ng-template let-conta pTemplate="item">
                    <div class="flex align-items-center justify-content-between w-full gap-2">
                      <span>{{ conta.nome }}</span>
                      <span class="text-sm font-semibold" [style.color]="conta.saldo >= 0 ? 'var(--primary-color)' : '#f43f5e'">
                        {{ conta.saldo | currency: 'BRL' : 'symbol' : '1.2-2' : 'pt-BR' }}
                      </span>
                    </div>
                  </ng-template>
                </p-select>
                @if (campoInvalido('contaOrigemId')) {
                  <small class="text-red-500">
                    <i class="pi pi-exclamation-circle"></i> Selecione a conta de origem.
                  </small>
                }
              </div>

              <!-- Conta de Destino -->
              <div class="flex flex-column gap-1">
                <label class="font-medium">Conta de Destino <span class="text-red-500">*</span></label>
                <p-select
                  formControlName="contaDestinoId"
                  [options]="contasDestino"
                  optionLabel="nome"
                  optionValue="id"
                  placeholder="Selecione a conta de destino"
                  styleClass="w-full"
                  [ngClass]="{ 'ng-invalid ng-dirty': campoInvalido('contaDestinoId') }"
                >
                  <ng-template let-conta pTemplate="item">
                    <div class="flex align-items-center justify-content-between w-full gap-2">
                      <div class="flex align-items-center gap-2">
                        <i class="pi pi-credit-card"></i>
                        <span>{{ conta.nome }}</span>
                        @if (!conta.ativa) {
                          <span class="text-xs text-red-500 font-bold">(inativa)</span>
                        }
                      </div>
                      <span class="text-sm font-semibold" [style.color]="conta.saldo >= 0 ? 'var(--primary-color)' : '#f43f5e'">
                        {{ conta.saldo | currency: 'BRL' : 'symbol' : '1.2-2' : 'pt-BR' }}
                      </span>
                    </div>
                  </ng-template>
                </p-select>

                @if (campoInvalido('contaDestinoId')) {
                  <small class="text-red-500">
                    <i class="pi pi-exclamation-circle"></i> Selecione a conta de destino.
                  </small>
                }

                <!-- Aviso de conta inativa -->
                @if (contaDestinoSelecionada && !contaDestinoSelecionada.ativa) {
                  <p-message
                    severity="warn"
                    text="A conta de destino está inativa. A transferência será bloqueada."
                  ></p-message>
                }
              </div>

              <!-- Descrição -->
              <div class="flex flex-column gap-1">
                <label class="font-medium">Descrição <span class="text-red-500">*</span></label>
                <input
                  pInputText
                  formControlName="descricao"
                  placeholder="Ex: Transferência mensal, Pagamento"
                  class="w-full"
                  [ngClass]="{ 'ng-invalid ng-dirty': campoInvalido('descricao') }"
                />
                @if (campoInvalido('descricao')) {
                  @if (campo('descricao').hasError('required')) {
                    <small class="text-red-500"><i class="pi pi-exclamation-circle"></i> A descrição é obrigatória.</small>
                  } @else if (campo('descricao').hasError('minlength')) {
                    <small class="text-red-500">
                      <i class="pi pi-info-circle"></i>
                      Mínimo de {{ campo('descricao').getError('minlength').requiredLength }} caracteres.
                    </small>
                  } @else if (campo('descricao').hasError('maxlength')) {
                    <small class="text-red-500"><i class="pi pi-info-circle"></i> Máximo de 100 caracteres.</small>
                  } @else if (campo('descricao').hasError('apenasEspacos')) {
                    <small class="text-red-500"><i class="pi pi-times-circle"></i> A descrição não pode conter apenas espaços.</small>
                  }
                } @else {
                  <small class="text-400"><i class="pi pi-info-circle"></i> Entre 3 e 100 caracteres.</small>
                }
              </div>

              <!-- Valor -->
              <div class="flex flex-column gap-1">
                <label class="font-medium">Valor <span class="text-red-500">*</span></label>
                <p-inputNumber
                  formControlName="valor"
                  mode="currency"
                  currency="BRL"
                  locale="pt-BR"
                  [minFractionDigits]="2"
                  placeholder="Ex: 500,00"
                  styleClass="w-full"
                  [ngClass]="{ 'ng-invalid ng-dirty': campoInvalido('valor') }"
                ></p-inputNumber>
                @if (campoInvalido('valor')) {
                  @if (campo('valor').hasError('required')) {
                    <small class="text-red-500"><i class="pi pi-exclamation-circle"></i> O valor é obrigatório.</small>
                  } @else if (campo('valor').hasError('min') || campo('valor').hasError('valorNaoPositivo')) {
                    <small class="text-red-500"><i class="pi pi-exclamation-circle"></i> O valor deve ser maior que R$&#x202F;0,00.</small>
                  } @else if (campo('valor').hasError('valorExcedeLimite')) {
                    <small class="text-red-500"><i class="pi pi-exclamation-circle"></i> Valor máximo por transferência: R$&#x202F;100.000,00.</small>
                  }
                } @else {
                  <small class="text-400"><i class="pi pi-info-circle"></i> Valor máximo: R$&#x202F;100.000,00 por operação.</small>
                }
              </div>

              <div class="pt-2">
                <button
                  pButton
                  label="Realizar Transferência"
                  icon="pi pi-send"
                  type="submit"
                  class="w-full p-button-raised"
                ></button>
              </div>
            </form>
          }
        </div>
      </p-card>
    </div>
  </div>
</div>
